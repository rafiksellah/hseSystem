{% extends 'base.html.twig' %}

{% block title %}État des Extincteurs{% endblock %}

{% block page_title %}
<i class="fas fa-file-excel text-success"></i> État des Extincteurs
{% endblock %}

{% block body %}
<div class="container-fluid">
  <!-- Barre d'actions -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-filter"></i> Filtres</h5>
        <div>
          <a href="{{ path('app_equipements_extincteurs_export_pdf', app.request.query.all) }}" 
             class="btn btn-danger">
            <i class="fas fa-file-pdf"></i> Export PDF
          </a>
          <a href="{{ path('app_equipements_extincteurs_export_excel') }}" 
             class="btn btn-success">
            <i class="fas fa-file-excel"></i> Export Excel
          </a>
        </div>
      </div>

      <!-- Formulaire de filtres -->
      <form method="GET" class="row g-3 mt-2">
        <div class="col-md-3">
          <label for="zone" class="form-label">Zone</label>
          <select name="zone" id="zone" class="form-select">
            <option value="">Toutes les zones</option>
            {% for key, zone_name in zones_disponibles %}
            <option value="{{ key }}" {{ search_params.zone == key ? 'selected' : '' }}>
              {{ zone_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="numerotation" class="form-label">Numérotation</label>
          <input type="text" name="numerotation" id="numerotation" class="form-control" 
                 value="{{ search_params.numerotation }}" 
                 placeholder="Ex: 4, EXT-001">
        </div>
        <div class="col-md-3">
          <label for="valide" class="form-label">Statut Validation</label>
          <select name="valide" id="valide" class="form-select">
            <option value="">Tous</option>
            <option value="oui" {{ search_params.valide == 'oui' ? 'selected' : '' }}>Validés</option>
            <option value="non" {{ search_params.valide == 'non' ? 'selected' : '' }}>Non validés</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search"></i> Filtrer
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Statistiques rapides -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <h3>{{ extincteurs|length }}</h3>
          <p class="mb-0">Total Extincteurs</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h3>{{ extincteurs|filter(e => e.isConforme() == true)|length }}</h3>
          <p class="mb-0">Conformes</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body text-center">
          <h3>{{ extincteurs|filter(e => e.isConforme() == false)|length }}</h3>
          <p class="mb-0">Non Conformes</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body text-center">
          <h3>{{ extincteurs|filter(e => e.isConforme() is null)|length }}</h3>
          <p class="mb-0">Non Inspectés</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau type Excel -->
  <div class="card shadow">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0"><i class="fas fa-table"></i> État des Extincteurs (Vue Excel)</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm mb-0" style="font-size: 11px;">
          <thead class="table-dark">
            <tr class="text-center">
              <th rowspan="2" class="align-middle">N°</th>
              <th rowspan="2" class="align-middle">Zone</th>
              <th rowspan="2" class="align-middle">Emplacement</th>
              <th rowspan="2" class="align-middle">Agent</th>
              <th rowspan="2" class="align-middle">Type</th>
              <th rowspan="2" class="align-middle">Capacité</th>
              <th colspan="3" class="bg-info">Dates</th>
              <th rowspan="2" class="align-middle">N° Série</th>
              <th rowspan="2" class="align-middle">Statut<br>Validation</th>
              <th rowspan="2" class="align-middle">Statut<br>Conformité</th>
              <th rowspan="2" class="align-middle">Dernière<br>Inspection</th>
              <th rowspan="2" class="align-middle">Actions</th>
            </tr>
            <tr class="text-center bg-info">
              <th>Fabrication</th>
              <th>Épreuve</th>
              <th>Fin de vie</th>
            </tr>
          </thead>
          <tbody>
            {% if extincteurs is empty %}
            <tr>
              <td colspan="14" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-2 d-block"></i>
                Aucun extincteur trouvé
              </td>
            </tr>
            {% else %}
            {% for extincteur in extincteurs %}
            <tr>
              <td class="text-center fw-bold">{{ extincteur.numerotation }}</td>
              <td>
                {% if extincteur.zone == 'SIMTIS' %}
                  <span class="badge bg-info">{{ extincteur.zone }}</span>
                {% else %}
                  <span class="badge bg-purple">{{ extincteur.zone }}</span>
                {% endif %}
              </td>
              <td>{{ extincteur.emplacement ?? '-' }}</td>
              <td class="text-center">{{ extincteur.agentExtincteur ?? '-' }}</td>
              <td>{{ extincteur.type ?? '-' }}</td>
              <td class="text-center">{{ extincteur.capacite ?? '-' }}</td>
              <td class="text-center">{{ extincteur.dateFabrication ? extincteur.dateFabrication|date('d/m/Y') : '-' }}</td>
              <td class="text-center">{{ extincteur.dateEpreuve ? extincteur.dateEpreuve|date('d/m/Y') : '-' }}</td>
              <td class="text-center">{{ extincteur.dateFinDeVie ? extincteur.dateFinDeVie|date('d/m/Y') : '-' }}</td>
              <td class="text-center">{{ extincteur.numeroSerie ?? '-' }}</td>
              <td class="text-center">
                {% if extincteur.valide %}
                  <span class="badge bg-success">Validé</span><br>
                  <small class="text-muted">{{ extincteur.dateValidation|date('d/m/Y') }}</small>
                {% else %}
                  <span class="badge bg-secondary">Non validé</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% set conformite = extincteur.statutConformite %}
                {% if conformite == 'Conforme' %}
                  <span class="badge bg-success">✓ Conforme</span>
                {% elseif conformite == 'Non conforme' %}
                  <span class="badge bg-danger">✗ Non conforme</span>
                {% else %}
                  <span class="badge bg-warning">⚠ {{ conformite }}</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% set derniere = extincteur.derniereInspection %}
                {% if derniere %}
                  {{ derniere.dateInspection|date('d/m/Y') }}<br>
                  <small class="text-muted">par {{ derniere.inspectePar.codeAgent }}</small>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="btn-group-vertical btn-group-sm">
                  {% if derniere %}
                    <a href="{{ path('app_equipements_inspection_details', {id: derniere.id}) }}" 
                       class="btn btn-info btn-sm" title="Voir inspection">
                      <i class="fas fa-eye"></i>
                    </a>
                    {% if is_granted('ROLE_ADMIN') %}
                      <a href="{{ path('app_equipements_inspection_modifier', {id: derniere.id}) }}" 
                         class="btn btn-warning btn-sm" title="Modifier inspection">
                        <i class="fas fa-edit"></i>
                      </a>
                    {% endif %}
                  {% else %}
                    <a href="{{ path('app_equipements_extincteurs_inspecter', {id: extincteur.id}) }}" 
                       class="btn btn-primary btn-sm" title="Inspecter">
                      <i class="fas fa-clipboard-check"></i>
                    </a>
                  {% endif %}
                  
                  {% if is_granted('ROLE_ADMIN') %}
                    <a href="{{ path('app_equipements_extincteurs_modifier', {id: extincteur.id}) }}" 
                       class="btn btn-secondary btn-sm" title="Modifier équipement">
                      <i class="fas fa-cog"></i>
                    </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="card-footer">
      <nav aria-label="Navigation">
        <ul class="pagination pagination-sm justify-content-center mb-0">
          {% for i in 1..total_pages %}
          <li class="page-item {{ i == current_page ? 'active' : '' }}">
            <a class="page-link" href="{{ path('app_equipements_extincteurs_etat', 
               app.request.query.all|merge({page: i})) }}">{{ i }}</a>
          </li>
          {% endfor %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<style>
.badge.bg-purple {
  background-color: #6f42c1 !important;
}
.table-sm td, .table-sm th {
  padding: 0.25rem;
  vertical-align: middle;
}
</style>
{% endblock %}

